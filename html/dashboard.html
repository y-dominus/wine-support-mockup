<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ダッシュボード | ワイサポ - Sommiaがサポートするワインマネジメントシステム</title>
    <link rel="icon" href="../assets/images/favicon.ico">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components/buttons.css">
    <link rel="stylesheet" href="../css/components/ai_chat.css">
    <link rel="stylesheet" href="../css/components/cards.css">
    <link rel="stylesheet" href="../css/components/wine-bottles.css">
    <link rel="stylesheet" href="../css/components/wine-optimization.css">
    <link rel="stylesheet" href="../css/components/wine-detail-modal.css">
    <link rel="stylesheet" href="../css/components/dashboard-alerts.css">
    <link rel="stylesheet" href="../css/pages/dashboard.css">
    <script defer src="../js/main.js"></script>
    <script defer src="../js/common_parts.js"></script>
    <script defer src="../js/ai_simulator.js"></script>
    <script defer src="../js/utils.js"></script>
    <script defer src="../js/components/wine-detail-modal.js"></script>
    <script defer src="../js/page_specific/dashboard_actions.js"></script>
    <script defer src="../js/page_specific/auto_order_recommendation.js"></script>
    <script defer src="../js/components/notifications.js"></script>
</head>
<body>
    <div id="header-placeholder"></div>
    
    <main>
        <div class="container">

            <!-- Sommiaからの在庫アラート -->
            <div class="sommia-alert-section" id="sommia-alert-section" style="display: none;">
                <div class="sommia-alert-content">
                    <!-- アバター -->
                    <div class="sommia-avatar-container">
                        <img src="../sommia.png" alt="Sommia" class="sommia-avatar">
                        <span class="sommia-name">Sommia</span>
                    </div>
                    
                    <!-- メッセージエリア -->
                    <div class="sommia-message-container">
                        <div class="sommia-message-header">
                            <span class="sommia-message-type">在庫アラート</span>
                        </div>
                        <div class="sommia-message-text">
                            <strong>キャンティ クラシコ リゼルヴァなど3銘柄</strong>については、そろそろ補充タイミングでしょうか。人気のワインですから、早めの補充がおすすめです！
                        </div>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="sommia-alert-actions">
                        <a href="orders/replenish_order.html" class="btn btn-primary">発注管理で確認</a>
                        <button class="btn btn-outline-secondary dismiss-alert">後で確認</button>
                    </div>
                    
                    <!-- 閉じるボタン -->
                    <button class="alert-close-btn" onclick="dismissDashboardAlert(this)" title="閉じる">&times;</button>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stats-card">
                    <div class="stats-icon">📊</div>
                    <div class="stats-content">
                        <div class="stats-title">今月の売上</div>
                        <div class="stats-value" data-target="245000" data-prefix="¥">¥0</div>
                        <div class="stats-trend positive">+12.5% 先月比</div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-icon">🍷</div>
                    <div class="stats-content">
                        <div class="stats-title">売れたボトル数</div>
                        <div class="stats-value" data-target="43">0</div>
                        <div class="stats-trend positive">+8本 先月比</div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-icon">⚠️</div>
                    <div class="stats-content">
                        <div class="stats-title">在庫アラート</div>
                        <div class="stats-value" data-target="3">0</div>
                        <div class="stats-trend negative">補充が必要</div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-icon">🔄</div>
                    <div class="stats-content">
                        <div class="stats-title">回転率</div>
                        <div class="stats-value" data-target="1.8">0</div>
                        <div class="stats-trend neutral">標準的</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-content">
                <div class="dashboard-main">
                    <!-- チャートセクション -->
                    <div class="dashboard-charts-row">
                        <!-- 売上トレンド -->
                        <div class="dashboard-section chart-half">
                            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                <h2 class="section-title" style="margin: 0;">売上トレンド</h2>
                                <a href="reports/sales_history.html" class="btn btn-sm btn-outline-primary">詳細履歴を見る</a>
                            </div>
                            <div class="dashboard-card">
                                <div class="chart-container">
                                    <canvas id="sales-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- カテゴリ別ワイン売上構成比 -->
                        <div class="dashboard-section chart-half">
                            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                <h2 class="section-title" style="margin: 0;">カテゴリ別ワイン売上構成比</h2>
                                <div class="chart-toggle-buttons">
                                    <button class="btn btn-sm btn-outline-secondary" id="volume-toggle" data-mode="volume">本数</button>
                                    <button class="btn btn-sm btn-primary" id="sales-toggle" data-mode="sales">金額</button>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="chart-container">
                                    <canvas id="wine-composition-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 人気ワインランキングと在庫アラート -->
                    <div class="dashboard-charts-row">
                        <div class="dashboard-section chart-half">
                            <h2 class="section-title">人気ワインランキング</h2>
                            <div class="dashboard-card">
                                <div class="ranking-list">
                                    <div class="ranking-item">
                                        <div class="ranking-position">1</div>
                                        <div class="ranking-wine">
                                            <div class="wine-name">キャンティ クラシコ リゼルヴァ</div>
                                            <div class="wine-info">赤 | イタリア | 12本販売</div>
                                        </div>
                                        <div class="ranking-value">¥96,000</div>
                                    </div>
                                    
                                    <div class="ranking-item">
                                        <div class="ranking-position">2</div>
                                        <div class="ranking-wine">
                                            <div class="wine-name">ソーヴィニヨン・ブラン</div>
                                            <div class="wine-info">白 | ニュージーランド | 8本販売</div>
                                        </div>
                                        <div class="ranking-value">¥56,000</div>
                                    </div>
                                    
                                    <div class="ranking-item">
                                        <div class="ranking-position">3</div>
                                        <div class="ranking-wine">
                                            <div class="wine-name">プロセッコ</div>
                                            <div class="wine-info">スパークリング | イタリア | 7本販売</div>
                                        </div>
                                        <div class="ranking-value">¥42,000</div>
                                    </div>
                                    
                                    <div class="ranking-item">
                                        <div class="ranking-position">4</div>
                                        <div class="ranking-wine">
                                            <div class="wine-name">メルロー</div>
                                            <div class="wine-info">赤 | チリ | 6本販売</div>
                                        </div>
                                        <div class="ranking-value">¥36,000</div>
                                    </div>
                                    
                                    <div class="ranking-item">
                                        <div class="ranking-position">5</div>
                                        <div class="ranking-wine">
                                            <div class="wine-name">シャルドネ</div>
                                            <div class="wine-info">白 | カリフォルニア | 5本販売</div>
                                        </div>
                                        <div class="ranking-value">¥35,000</div>
                                    </div>
                                </div>
                                
                                <div class="see-more-link">
                                    <a href="reports/sales_history.html">売上履歴を見る →</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-section chart-half">
                            <h2 class="section-title">在庫アラート</h2>
                            <div class="dashboard-card">
                                <div class="alert-list">
                                    <div class="alert-item">
                                        <div class="alert-icon warning">⚠️</div>
                                        <div class="alert-content">
                                            <div class="alert-title">キャンティ クラシコ リゼルヴァ</div>
                                            <div class="alert-description">残り2本 - 売れ筋商品</div>
                                        </div>
                                        <div class="alert-action">
                                            <button class="btn btn-sm btn-outline-primary">補充</button>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-item">
                                        <div class="alert-icon warning">⚠️</div>
                                        <div class="alert-content">
                                            <div class="alert-title">ソーヴィニヨン・ブラン</div>
                                            <div class="alert-description">残り1本 - 早急な補充が必要</div>
                                        </div>
                                        <div class="alert-action">
                                            <button class="btn btn-sm btn-outline-primary">補充</button>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-item">
                                        <div class="alert-icon info">ℹ️</div>
                                        <div class="alert-content">
                                            <div class="alert-title">メルロー</div>
                                            <div class="alert-description">残り3本 - もうすぐ補充が必要</div>
                                        </div>
                                        <div class="alert-action">
                                            <button class="btn btn-sm btn-outline-primary">補充</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="see-more-link">
                                    <a href="orders/replenish_order.html">補充発注へ →</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 最下部フルワイドセクション: Sommiaからのワインリスト最適化提案 -->
                <div class="dashboard-full-width-section">
                    <!-- ワインリスト最適化提案セクション -->
                    <div class="dashboard-section">
                        <h2 class="section-title">🍷 Sommiaからのワインリスト最適化提案</h2>
                        <div class="wine-optimization-card">
                            <div class="optimization-header">
                                <img src="../sommia.png" alt="Sommia" class="ai-avatar-inline">
                                <div class="optimization-message">
                                    <div class="optimization-title">ワインリストの最適化で売上アップのチャンスです！</div>
                                    <div class="optimization-summary">売上データを分析した結果、<strong>3銘柄の入替え</strong>で<strong class="highlight-number">約15%の売上向上</strong>が期待できます。</div>
                                </div>
                            </div>
                            <div class="optimization-preview">
                                <div class="optimization-stats">
                                    <div class="stat-item">
                                        <div class="stat-icon remove">↓</div>
                                        <div class="stat-content">
                                            <div class="stat-number">2</div>
                                            <div class="stat-label">削除推奨</div>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-icon add">↑</div>
                                        <div class="stat-content">
                                            <div class="stat-number">3</div>
                                            <div class="stat-label">追加推奨</div>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-icon profit">💰</div>
                                        <div class="stat-content">
                                            <div class="stat-number">+15%</div>
                                            <div class="stat-label">売上向上予測</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="optimization-preview-wines">
                                    <div class="preview-section">
                                        <h4>🔴 削除推奨</h4>
                                        <div class="wine-preview-list">
                                            <div class="wine-preview-item low-performance">
                                                <span class="wine-name">シラーズ 2021</span>
                                                <span class="wine-reason">3ヶ月間売上なし</span>
                                            </div>
                                            <div class="wine-preview-item low-performance">
                                                <span class="wine-name">リースリング 2022</span>
                                                <span class="wine-reason">回転率0.3回/月</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="preview-section">
                                        <h4>🟢 追加推奨</h4>
                                        <div class="wine-preview-list">
                                            <div class="wine-preview-item high-potential">
                                                <span class="wine-name">ヴェルメンティーノ 2023</span>
                                                <span class="wine-reason">夏季需要↑予測</span>
                                            </div>
                                            <div class="wine-preview-item high-potential">
                                                <span class="wine-name">サンジョヴェーゼ 2021</span>
                                                <span class="wine-reason">他店で人気上昇</span>
                                            </div>
                                            <div class="wine-preview-item high-potential">
                                                <span class="wine-name">アルバリーニョ 2023</span>
                                                <span class="wine-reason">コスパ優秀</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="optimization-actions">
                                <button class="btn btn-outline-secondary" id="skip-optimization">今回はスキップ</button>
                                <a href="wine_optimization.html" class="btn btn-primary">詳細分析を見る</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- フローティングチャットボタン -->
    <div class="floating-chat-button" id="floating-chat-btn">
        <img src="../sommia.png" alt="Sommia" class="chat-avatar">
        <div class="notification-badge" id="chat-notification-badge">3</div>
    </div>
    
    <!-- チャットウィンドウ -->
    <div class="floating-chat-window" id="floating-chat-window">
        <div class="chat-header">
            <img src="../sommia.png" alt="Sommia" class="chat-avatar-small">
            <span class="chat-title">Sommia - ソムリエAI</span>
            <button class="chat-close-btn" id="chat-close-btn">×</button>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="ai-message">
                <img src="../sommia.png" alt="Sommia" class="chat-avatar-message">
                <div class="message-content">
                    こんにちは！今日は3つの重要な提案があります。
                </div>
            </div>
            
            <!-- Sommiaからの提案一覧 -->
            <div class="suggestions-list" id="suggestions-list">
                <div class="suggestion-card" data-url="wine_optimization.html">
                    <div class="suggestion-icon">🍷</div>
                    <div class="suggestion-content">
                        <div class="suggestion-title">ワインリスト最適化</div>
                        <div class="suggestion-description">3銘柄の入替えで約15%の売上向上が期待</div>
                    </div>
                    <div class="suggestion-action">詳細</div>
                </div>
                
                <div class="suggestion-card" data-url="orders/replenish_order.html">
                    <div class="suggestion-icon">⚠️</div>
                    <div class="suggestion-content">
                        <div class="suggestion-title">在庫アラート</div>
                        <div class="suggestion-description">キャンティなど3銘柄が補充必要</div>
                    </div>
                    <div class="suggestion-action">確認</div>
                </div>
                
                <div class="suggestion-card" data-url="products/product_list.html">
                    <div class="suggestion-icon">🌞</div>
                    <div class="suggestion-content">
                        <div class="suggestion-title">季節のおすすめ</div>
                        <div class="suggestion-description">初夏向け軽やかな白ワイン・ロゼ</div>
                    </div>
                    <div class="suggestion-action">見る</div>
                </div>
            </div>
            
            <div class="chat-actions" id="chat-actions">
                <button class="action-btn-square" data-action="sales">
                    <div class="action-icon">📊</div>
                    <div class="action-label">売上チェック</div>
                </button>
                <button class="action-btn-square" data-action="inventory">
                    <div class="action-icon">🍷</div>
                    <div class="action-label">在庫管理</div>
                </button>
                <button class="action-btn-square" data-action="order">
                    <div class="action-icon">📦</div>
                    <div class="action-label">発注</div>
                </button>
                <button class="action-btn-square" data-action="help">
                    <div class="action-icon">❓</div>
                    <div class="action-label">ヘルプ</div>
                </button>
            </div>
        </div>
    </div>
    
    <div id="footer-placeholder"></div>
    
    <!-- Chart.jsの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ダッシュボードアラートを閉じる関数
        function dismissDashboardAlert(button) {
            const alertSection = button.closest('.sommia-alert-section');
            if (alertSection) {
                alertSection.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                alertSection.style.opacity = '0';
                alertSection.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    alertSection.style.display = 'none';
                    // ローカルストレージに閉じた状態を保存
                    localStorage.setItem('dashboard-sommia-alert-dismissed', 'true');
                }, 300);
            }
        }
        
        // Sommiaアラートの表示制御
        function checkSommiaAlertDisplay() {
            const dismissed = localStorage.getItem('dashboard-sommia-alert-dismissed');
            const alertSection = document.getElementById('sommia-alert-section');
            
            if (!dismissed && alertSection) {
                alertSection.style.display = 'block';
            }
        }
        
        // チャートの描画と初期化
        document.addEventListener('DOMContentLoaded', function() {
            // Sommiaアラートの表示状態をチェック
            checkSommiaAlertDisplay();
            
            // 売上トレンドチャートの初期化
            const salesCtx = document.getElementById('sales-chart').getContext('2d');
            
            const salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月'],
                    datasets: [
                        {
                            label: 'ワイン売上',
                            data: [180000, 195000, 185000, 218000, 245000],
                            borderColor: '#FF4D00',
                            backgroundColor: 'rgba(255, 77, 0, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ボトル数',
                            data: [30, 33, 29, 35, 43],
                            borderColor: '#884591',
                            backgroundColor: 'rgba(136, 69, 145, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '売上金額（円）'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'ボトル数'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: true
                        }
                    }
                }
            });
            
            // 価格帯別ワイン構成比チャートの初期化
            initializeWineCompositionChart();
            
            // AIチャットの提案チップクリック処理
            const suggestionChips = document.querySelectorAll('.ai-suggestion-chip');
            suggestionChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    const text = this.textContent;
                    
                    // ユーザーメッセージを表示
                    addChatMessage(null, null, text, '.ai-chat-body', true);
                    
                    // AIの「考え中」表示を追加
                    const thinkingId = addAiThinking();
                    
                    // 遅延してAIの応答を表示
                    setTimeout(() => {
                        // 「考え中」表示を削除
                        removeAiThinking(thinkingId);
                        
                        // AIの応答を表示
                        if (text.includes('在庫を確認')) {
                            addChatMessage('myCellar', 'overview');
                            setTimeout(() => {
                                window.location.href = 'my_cellar/my_cellar.html';
                            }, 1500);
                        } else if (text.includes('補充発注')) {
                            addChatMessage('orders', 'replenishOrder');
                            setTimeout(() => {
                                window.location.href = 'orders/replenish_order.html';
                            }, 1500);
                        }
                    }, 1000);
                });
            });
            
            // KPIカウントアップアニメーション
            initializeKPICountUp();
            
            // チャート切り替えボタンの初期化
            initializeChartToggle();
            
            // フローティングチャットの初期化
            initializeFloatingChat();
            
            // 補充ボタンのイベント処理
            const replenishButtons = document.querySelectorAll('.alert-action .btn');
            replenishButtons.forEach(button => {
            button.addEventListener('click', function() {
                window.location.href = 'orders/replenish_order.html';
        });
        });
    });
    
    // KPIカウントアップアニメーションの初期化
    function initializeKPICountUp() {
    const kpiCards = document.querySelectorAll('.stats-card');
    
    const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
    if (entry.isIntersecting) {
    const valueElement = entry.target.querySelector('.stats-value');
    const targetValue = parseFloat(valueElement.dataset.target);
    const prefix = valueElement.dataset.prefix || '';
    const suffix = valueElement.dataset.suffix || '';
    
    if (targetValue) {
    // カウントアップ実行
    countUpAnimation(valueElement, 0, targetValue, prefix, suffix, 2000);
    
    // 一度アニメーションしたら監視を停止
    observer.unobserve(entry.target);
    }
    }
    });
    }, {
    threshold: 0.3 // 30%表示されたらアニメーション開始
    });
    
    kpiCards.forEach(card => {
    observer.observe(card);
    });
    }
    
    // カウントアップアニメーション関数
    function countUpAnimation(element, start, end, prefix = '', suffix = '', duration = 2000) {
        const startTime = performance.now();
        const difference = end - start;
        
        // カウント中クラスを追加
        element.classList.add('counting');
        
        function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // easeOutCubic イージング関数
            const easeProgress = 1 - Math.pow(1 - progress, 3);
            
            const currentValue = start + (difference * easeProgress);
            
            // 数値のフォーマット
            let displayValue;
            if (end >= 1000) {
                // 1000以上は3桁区切り
                displayValue = Math.floor(currentValue).toLocaleString();
            } else if (end % 1 !== 0) {
                // 小数点あり
                displayValue = currentValue.toFixed(1);
            } else {
                // 整数
                displayValue = Math.floor(currentValue).toString();
            }
            
            element.textContent = prefix + displayValue + suffix;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                // 最終値を正確に設定
                let finalValue;
                if (end >= 1000) {
                    finalValue = end.toLocaleString();
                } else if (end % 1 !== 0) {
                    finalValue = end.toString();
                } else {
                    finalValue = end.toString();
                }
                element.textContent = prefix + finalValue + suffix;
                
                // カウント中クラスを削除
                setTimeout(() => {
                    element.classList.remove('counting');
                }, 200);
            }
        }
        
        requestAnimationFrame(animate);
    }
            
            // フローティングチャットの初期化関数
            function initializeFloatingChat() {
        const chatButton = document.getElementById('floating-chat-btn');
        const chatWindow = document.getElementById('floating-chat-window');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const actionButtons = document.querySelectorAll('.action-btn-square');
        const notificationBadge = document.getElementById('chat-notification-badge');
        
        // チャットボタンクリック時
        chatButton.addEventListener('click', function() {
            chatWindow.classList.toggle('show');
            // 通知バッジを非表示
            notificationBadge.style.display = 'none';
        });
        
        // チャット閉じるボタン
        chatCloseBtn.addEventListener('click', function() {
            chatWindow.classList.remove('show');
        });
        
        // アクションボタンの処理
        actionButtons.forEach(button => {
            button.addEventListener('click', function() {
                const action = this.dataset.action;
                handleChatAction(action);
            });
        });
        
        // 提案カードのクリック処理
        const suggestionCards = document.querySelectorAll('.suggestion-card');
        suggestionCards.forEach(card => {
            card.addEventListener('click', function() {
                const url = this.dataset.url;
                window.location.href = url;
            });
        });
        
        // チャットウィンドウ外をクリックで閉じる
        document.addEventListener('click', function(event) {
            if (!chatWindow.contains(event.target) && !chatButton.contains(event.target)) {
                chatWindow.classList.remove('show');
            }
        });
    }
    
    // チャットアクションの処理
    function handleChatAction(action) {
        const chatBody = document.getElementById('chat-body');
        const chatActions = document.getElementById('chat-actions');
        
        // ユーザー選択を表示
        const userChoice = document.createElement('div');
        userChoice.className = 'user-message';
        userChoice.innerHTML = `
            <div class="message-content user">
                ${getActionText(action)}
            </div>
        `;
        userChoice.style.textAlign = 'right';
        userChoice.style.marginBottom = 'var(--spacing-sm)';
        
        chatBody.insertBefore(userChoice, chatActions);
        
        // AI応答を表示
        setTimeout(() => {
            const aiResponse = document.createElement('div');
            aiResponse.className = 'ai-message';
            aiResponse.innerHTML = `
                <img src="../sommia.png" alt="Sommia" class="chat-avatar-message">
                <div class="message-content">
                    ${getAIResponse(action)}
                </div>
            `;
            chatBody.insertBefore(aiResponse, chatActions);
            
            // サブアクションを表示
            setTimeout(() => {
                showSubActions(action, chatBody, chatActions);
            }, 500);
            
            // スクロールを下に
            chatBody.scrollTop = chatBody.scrollHeight;
        }, 800);
    }
    
    // アクションテキストを取得
    function getActionText(action) {
        const texts = {
            sales: '📊 売上チェック',
            inventory: '🍷 在庫管理',
            order: '📦 発注',
            help: '❓ ヘルプ'
        };
        return texts[action] || action;
    }
    
    // AI応答を取得
    function getAIResponse(action) {
        const responses = {
            sales: '売上チェックですね！ダッシュボードで最新の売上情報を確認できます。',
            inventory: '在庫管理のお手伝いをします！マイセラーで在庫状況や売上入力ができます。',
            order: '発注関連のサポートをいたします！補充発注や履歴確認ができます。',
            help: 'ワイサポの使い方でお困りですか？どんなことでもお気軽にお問い合わせください。'
        };
        return responses[action] || 'お手伝いします！';
    }
    
    // サブアクションを表示
    function showSubActions(action, chatBody, chatActions) {
        const subActions = document.createElement('div');
        subActions.className = 'sub-actions';
        
        const actionMappings = {
            sales: [
                { text: 'ダッシュボードを開く', url: 'dashboard.html' },
                { text: '売上履歴を見る', url: 'reports/sales_history.html' }
            ],
            inventory: [
                { text: 'マイセラーを開く', url: 'my_cellar/my_cellar.html' },
                { text: '売上入力をする', url: 'my_cellar/sales_input.html' }
            ],
            order: [
                { text: '補充発注をする', url: 'orders/replenish_order.html' },
                { text: '発注履歴を見る', url: 'orders/order_history.html' }
            ],
            help: [
                { text: 'ユーザーガイドを見る', url: '#' },
                { text: 'お問い合わせ', url: '#' }
            ]
        };
        
        const actions = actionMappings[action] || [];
        
        actions.forEach(actionItem => {
            const btn = document.createElement('button');
            btn.className = 'sub-action-btn';
            
            // 提案アクションの場合は詳細説明を追加
            if (action === 'suggestions' && actionItem.description) {
                btn.innerHTML = `
                    <div class="suggestion-item">
                        <div class="suggestion-title">${actionItem.text}</div>
                        <div class="suggestion-description">${actionItem.description}</div>
                    </div>
                `;
                btn.classList.add('suggestion-btn');
            } else {
                btn.textContent = actionItem.text;
            }
            
            btn.addEventListener('click', function() {
                window.location.href = actionItem.url;
            });
            subActions.appendChild(btn);
        });
        
        // メニューに戻るボタン
        const backBtn = document.createElement('button');
        backBtn.className = 'sub-action-btn back-btn';
        backBtn.textContent = '← メニューに戻る';
        backBtn.addEventListener('click', function() {
            resetChatToMain();
        });
        subActions.appendChild(backBtn);
        
        chatBody.insertBefore(subActions, chatActions);
        chatBody.scrollTop = chatBody.scrollHeight;
    }
    
    // チャートをメインメニューにリセット
    function resetChatToMain() {
        const chatBody = document.getElementById('chat-body');
        const chatActions = document.getElementById('chat-actions');
        
        // 既存のメッシージをクリア
        const messages = chatBody.querySelectorAll('.ai-message:not(:first-child), .user-message, .sub-actions');
        messages.forEach(msg => msg.remove());
        
        // メインアクションボタンを再表示
        chatActions.style.display = 'flex';
    }
    
    // 価格帯別ワイン構成比チャートの初期化
    function initializeWineCompositionChart() {
        const ctx = document.getElementById('wine-composition-chart').getContext('2d');
        
        // データ定義
        const wineData = {
            volume: {
                // 価格帯別の本数データ
                priceRanges: {
                    '~3,000円': { red: 8, white: 12, rose: 3, sparkling: 4 },
                    '3,001~5,000円': { red: 15, white: 10, rose: 2, sparkling: 6 },
                    '5,001~8,000円': { red: 12, white: 8, rose: 1, sparkling: 3 },
                    '8,001円~': { red: 6, white: 4, rose: 1, sparkling: 2 }
                }
            },
            sales: {
                // 価格帯別の売上データ（千円単位）
                priceRanges: {
                    '~3,000円': { red: 16, white: 24, rose: 6, sparkling: 8 },
                    '3,001~5,000円': { red: 60, white: 40, rose: 8, sparkling: 24 },
                    '5,001~8,000円': { red: 72, white: 48, rose: 6, sparkling: 18 },
                    '8,001円~': { red: 54, white: 36, rose: 9, sparkling: 18 }
                }
            }
        };
        
        // 初期表示は売上
        let currentMode = 'sales';
        
        // チャートデータを生成する関数
        function generateChartData(mode) {
            const data = wineData[mode];
            const wineTypes = ['red', 'white', 'rose', 'sparkling'];
            const wineTypeLabels = ['赤ワイン', '白ワイン', 'ロゼ', 'スパークリング'];
            const priceRanges = Object.keys(data.priceRanges);
            
            return {
                labels: wineTypeLabels, // Y軸のラベル（ワインタイプ）
                datasets: priceRanges.map((priceRange, index) => {
                    const colors = [
                        '#FF6B6B', // ~3,000円 - 薄い赤
                        '#4ECDC4', // 3,001~5,000円 - ティール
                        '#45B7D1', // 5,001~8,000円 - 青
                        '#96CEB4'  // 8,001円~ - 薄い緑
                    ];
                    
                    return {
                        label: priceRange,
                        data: wineTypes.map(type => data.priceRanges[priceRange][type]),
                        backgroundColor: colors[index],
                        borderColor: colors[index],
                        borderWidth: 1
                    };
                })
            };
        }
        
        // チャート作成
        window.wineCompositionChart = new Chart(ctx, {
            type: 'bar',
            data: generateChartData(currentMode),
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // 横向き棒グラフ
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.x;
                                const unit = currentMode === 'volume' ? '本' : '千円';
                                return `${label}: ${value}${unit}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: currentMode === 'volume' ? 'ボトル数' : '売上（千円）'
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'ワイン種類'
                        }
                    }
                }
            }
        });
        
        // チャートデータを更新する関数
        window.updateWineCompositionChart = function(mode) {
            currentMode = mode;
            const newData = generateChartData(mode);
            
            // データを更新
            window.wineCompositionChart.data = newData;
            
            // X軸のタイトルを更新
            window.wineCompositionChart.options.scales.x.title.text = 
                mode === 'volume' ? 'ボトル数' : '売上（千円）';
            
            // チャートを再描画
            window.wineCompositionChart.update('active');
        };
    }
    
    // チャート切り替えボタンの初期化
    function initializeChartToggle() {
        const volumeToggle = document.getElementById('volume-toggle');
        const salesToggle = document.getElementById('sales-toggle');
        
        // ボタンクリックイベント
        volumeToggle.addEventListener('click', function() {
            // ボタンの状態を切り替え
            volumeToggle.classList.remove('btn-outline-secondary');
            volumeToggle.classList.add('btn-primary');
            salesToggle.classList.remove('btn-primary');
            salesToggle.classList.add('btn-outline-secondary');
            
            // チャートを更新
            window.updateWineCompositionChart('volume');
        });
        
        salesToggle.addEventListener('click', function() {
            // ボタンの状態を切り替え
            salesToggle.classList.remove('btn-outline-secondary');
            salesToggle.classList.add('btn-primary');
            volumeToggle.classList.remove('btn-primary');
            volumeToggle.classList.add('btn-outline-secondary');
            
            // チャートを更新
            window.updateWineCompositionChart('sales');
        });
    }
    </script>
</body>
</html>